# cozy-docker

Simple Cozy docker image provided without CouchDB nor reverse proxy.

## What is cozy ?

> Store, sync, and share your data just the way you want it.

More informations on [Cozy website](https://cozy.io).

## Installation

* Install Docker
* Fetch cozy-docker image:
```bash
sudo docker pull waidd/cozy
```
* Or build it manually by running:
```bash
sudo docker build -t waidd/cozy github.com/waidd/cozy-docker
```

Access tokens are generated at the first launch, so you don't need to build the image yourself.

## Usage
### CouchDB

In order to set his own credentials, Cozy need a dedicated CouchDB database. You can get one this way :

* Fetch CouchDB image:
```bash
sudo docker pull couchdb
```
* Start CouchDB container:
```bash
sudo docker run
  --detach \
  --restart=always \
  --volume /path/to/your/backup/couchdb:/usr/local/var/lib/couchdb # optional: backup of your database
  --name cozy-couchdb \
  couchdb
```

Logs are available with the following command: `sudo docker logs cozy-couchdb`.

### Cozy

Start Cozy container:
```bash
sudo docker run \
  --detach \
  --restart=always \
  --publish 9104:9104 \
  --volume /path/to/your/backup/cozy:/etc/cozy #optional: backup of your database credentials
  --volume /path/to/your/log/cozy/apps:/usr/local/var/log/cozy # optional: quick access to your apps logs
  --link cozy-couchdb:couchdb \
  --name cozy \
  waidd/cozy
```

The first launch may be long as cozy need to install some dependencies.

Logs of the applications are available in your `/path/to/your/log/apps` directory.
Logs of the controller can be obtained with the command: `sudo docker logs cozy`

### Reverse Proxy

Use a reserve proxy to serve cozy application.

Sample nginx vhost :
```
server {
  listen 80;
  listen [::]:80;
  server_name my-cozy-url.com;
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl;
  listen [::]:443 ssl;

  # Self signed certs generated by the ssl-cert package
  # Don't use them in a production server!
  # You should provide your own certificates.
  include snippets/snakeoil.conf;

  server_name my-website.com;

  location / {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_pass http://127.0.0.1:9104;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
}
```

##  Update / Migrate / Backup

### Update

#### Couchdb

Be sure that the `/usr/local/var/lib/couchdb` directory of your couchdb container is stored on your host system.
Stop and delete both your couchdb and Cozy containers, update your image and then recreate them.
The Cozy container will set new credentials and reinstall all your applications.

#### Cozy

Be sure that the `/etc/cozy` directory of your Cozy container is stored on your host system.
Stop and delete your Cozy container, update your image and then recreate it. It will reuse your credentials and reinstall all your applications.

### Backup / Restore

Cozy's revelant data are stored in the `/usr/local/var/lib/couchdb` directory of your couchdb container. You just have to backup it and you are good.
To restore your data, start a new couchdb container using your backup directory, then start a new cozy container.

### Migrate

In order to migrate your Cozy stack from a server to another, you just have to transfer your previous backup and start new containers using it.